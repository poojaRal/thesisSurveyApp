!function(){"use strict";angular.module("surveyApp").controller("surveyEndController",["$scope","$location","serviceCall","activeData",function(e,r,o,a){e.title="Submit",e.error={},e.error.message,e.success={},e.success.message,e.payloadForService,e.submit=function(){var r=/^\d+$/;r.test(e.pin)?(e.error.message="",localStorage.surveyAppPin===e.pin?(console.log("matched"),e.submitCall()):e.error.message="PIN mismatch. Please try again."):angular.isUndefined(e.pin)||""===e.pin||" "===e.pin?e.error.message="PIN cannot be blank.":e.error.message="PIN should contain numbers only."},e.submitCall=function(){$("#loader").show(),e.surveyID=a.getSurveyID();var r=[];angular.forEach(localStorage,function(o,a){if(a.indexOf(e.surveyID.toString()+":")>-1){var t=a.split(":")[1],n=[],s=[];o.indexOf("location")>-1?s.push(JSON.parse(o)):n.push(o);var i={quesID:t,selectedOptions:n,bodyPain:s};r.push(i)}});var t=e.surveyID.toString(),n=(new Date).getTime();e.payloadForService='{"surveyInstanceID":'+t+',"timeStamp":'+n+',"surveyResults":'+JSON.stringify(r)+"}";var s=new o("submit_survey","POST");"remote"==localStorage.dataSource&&s.call(e.payloadForService,e.submitCallSuccess,e.submitCallError),"local"==localStorage.dataSource&&s.call(e.payloadForService,e.submitCallSuccess,e.submitCallError,"json/submitSurvey.json")},e.submitCallSuccess=function(r,o){if(console.log(a.getError()),console.log(o),$("#loader").hide(),console.log(r.message),"Success"===r.message){e.success.message="Submitted successfully.",localStorage.surveyInProgress=-1,$("#submitBtn").hide();var t=e.getMobileOperatingSystem();e.surveyID;if("iOS"===t){var n=window.navigator.standalone,s=window.navigator.userAgent.toLowerCase(),i=/safari/.test(s);!n&&i||(s.indexOf("painreport")>-1?$("#exitBtn").hide():n||i||$("#exitBtn").hide())}}else e.error.message=r.message,e.saveSubmissionToLocalStorage();a.setSurveyCompleted(!0),e.clearLocalStorage()},e.submitCallError=function(r,o){console.log(a.getError()),$("#loader").hide(),console.log("here"),console.log(o),console.log(r),e.saveSubmissionToLocalStorage(),"offline"===a.getError()?e.error.message="Unable to submit. Please check internet connectivity.":"internalServerError"===a.getError()?e.error.message="Unable to submit. There's a server error.":"notFound"===a.getError()?e.error.message="Unable to submit. API not found on server. Incorrect route.":"unknownError"===a.getError()?e.error.message="Unable to submit. Please check internet connectivity or contact administrator.":e.error.message="Unable to submit. Please contact administrator."},e.saveSubmissionToLocalStorage=function(){var r=e.surveyID,o=e.payloadForService;console.log(r+" : "+o),localStorage[r]=o,e.callNativeSubmitErrorHandler()},e.clearLocalStorage=function(){console.log("here");var r=a.getSurveyQuestions();$.each(r,function(r,o){console.log(e.surveyID+":"+o.quesID),localStorage.removeItem(e.surveyID+":"+o.quesID)}),localStorage.removeItem("reloadBackupSurveyID"),localStorage.removeItem("reloadBackupSurveyName"),localStorage.removeItem("reloadBackupSurveyQuestions")},e.changePage=function(e){r.path(e)},e.callNativeSubmitErrorHandler=function(){var r=e.getMobileOperatingSystem(),o=e.surveyID;if(console.log(r),"iOS"===r){var a=window.navigator.standalone,t=window.navigator.userAgent.toLowerCase(),n=/safari/.test(t);!a&&n||(t.indexOf("painreport")>-1?window.location="jsHandler://submitError?json="+localStorage[o]:a||n||(window.location="jsHandler://submitError?json="+localStorage[o]))}else"Android"===r&&e.testNativeAndroidAppUA()&&jsHandler.submitError(localStorage.surveyID)},e.closeApp=function(){var r=e.getMobileOperatingSystem();if(console.log(r),"iOS"===r){var o=window.navigator.standalone,a=window.navigator.userAgent.toLowerCase(),t=/safari/.test(a);!o&&t?e.changePage("/home"):a.indexOf("painreport")>-1?window.location="jsHandler://killApp":o||t||(window.location="jsHandler://killApp")}else"Android"===r&&e.testNativeAndroidAppUA()?jsHandler.killApp():e.changePage("/home")},e.testNativeAndroidAppUA=function(){return/painreport/.test(navigator.userAgent)},e.getMobileOperatingSystem=function(){var e=navigator.userAgent||navigator.vendor||window.opera;return e.match(/iPad/i)||e.match(/iPhone/i)||e.match(/iPod/i)?"iOS":e.match(/Android/i)?"Android":"unknown"}}])}();