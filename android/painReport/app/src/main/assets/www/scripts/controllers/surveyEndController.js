!function(){"use strict";angular.module("surveyApp").controller("surveyEndController",["$scope","$location","serviceCall","activeData",function(e,o,r,a){e.title="Submit",e.error={},e.error.message,e.success={},e.success.message,e.payloadForService,e.submit=function(){var o=/^\d+$/;o.test(e.pin)?(e.error.message="",localStorage.surveyAppPin===e.pin?(console.log("matched"),e.submitCall()):e.error.message="PIN mismatch. Please try again."):angular.isUndefined(e.pin)||""===e.pin||" "===e.pin?e.error.message="PIN cannot be blank.":e.error.message="PIN should contain numbers only."},e.submitCall=function(){$("#loader").show(),e.surveyID=a.getSurveyID();var o=[];console.log("Inside submitCall"),console.log(localStorage.length),angular.forEach(localStorage,function(r,a){if(a.indexOf(e.surveyID.toString()+":")>-1){var t=a.split(":")[1],n=[],s=[],l=0,i=0,c=0;r.indexOf("location")>-1?s.push(JSON.parse(r)):n.push(r),console.log("quesID is : ",t),null!==localStorage.getItem("ansTs:"+t)&&(l=localStorage.getItem("ansTs:"+t)),null!==localStorage.getItem("prev:"+t)&&(i=localStorage.getItem("prev:"+t)),null!==localStorage.getItem("next:"+t)&&(c=localStorage.getItem("next:"+t));var u={quesID:t,selectedOptions:n,bodyPain:s,ansTimeStamp:l,prevTimeStamp:i,nextTimeStamp:c};o.push(u)}}),console.log("Survey Results"),console.log(JSON.stringify(o));var t=e.surveyID.toString(),n=(new Date).getTime();e.payloadForService='{"surveyInstanceID":'+t+',"timeStamp":'+n+',"surveyResults":'+JSON.stringify(o)+"}";var s=new r("submit_survey","POST");"remote"==localStorage.dataSource&&s.call(e.payloadForService,e.submitCallSuccess,e.submitCallError),"local"==localStorage.dataSource&&s.call(e.payloadForService,e.submitCallSuccess,e.submitCallError,"json/submitSurvey.json")},e.submitCallSuccess=function(o,r){if(console.log(a.getError()),console.log(r),$("#loader").hide(),console.log(o.message),"Success"===o.message){e.success.message="Submitted successfully.",localStorage.surveyInProgress=-1,$("#submitBtn").hide();var t=e.getMobileOperatingSystem();e.surveyID;if("iOS"===t){var n=window.navigator.standalone,s=window.navigator.userAgent.toLowerCase(),l=/safari/.test(s);!n&&l||(s.indexOf("painreport")>-1?$("#exitBtn").hide():n||l||$("#exitBtn").hide())}}else e.error.message=o.message,e.saveSubmissionToLocalStorage();a.setSurveyCompleted(!0),e.clearLocalStorage()},e.submitCallError=function(o,r){console.log(a.getError()),$("#loader").hide(),console.log("here"),console.log(r),console.log(o),e.saveSubmissionToLocalStorage(),"offline"===a.getError()?e.error.message="Unable to submit. Please check internet connectivity.":"internalServerError"===a.getError()?e.error.message="Unable to submit. There's a server error.":"notFound"===a.getError()?e.error.message="Unable to submit. API not found on server. Incorrect route.":"unknownError"===a.getError()?e.error.message="Unable to submit. Please check internet connectivity or contact administrator.":e.error.message="Unable to submit. Please contact administrator."},e.saveSubmissionToLocalStorage=function(){var o=e.surveyID,r=e.payloadForService;console.log(o+" : "+r),localStorage[o]=r,e.callNativeSubmitErrorHandler()},e.clearLocalStorage=function(){console.log("here");var o=a.getSurveyQuestions();$.each(o,function(o,r){console.log(e.surveyID+":"+r.quesID),localStorage.removeItem(e.surveyID+":"+r.quesID)}),localStorage.removeItem("reloadBackupSurveyID"),localStorage.removeItem("reloadBackupSurveyName"),localStorage.removeItem("reloadBackupSurveyQuestions")},e.changePage=function(e){o.path(e)},e.callNativeSubmitErrorHandler=function(){var o=e.getMobileOperatingSystem(),r=e.surveyID;if(console.log(o),"iOS"===o){var a=window.navigator.standalone,t=window.navigator.userAgent.toLowerCase(),n=/safari/.test(t);!a&&n||(t.indexOf("painreport")>-1?window.location="jsHandler://submitError?json="+localStorage[r]:a||n||(window.location="jsHandler://submitError?json="+localStorage[r]))}else"Android"===o&&e.testNativeAndroidAppUA()&&jsHandler.submitError(localStorage.surveyID)},e.closeApp=function(){var o=e.getMobileOperatingSystem();if(console.log(o),"iOS"===o){var r=window.navigator.standalone,a=window.navigator.userAgent.toLowerCase(),t=/safari/.test(a);!r&&t?e.changePage("/home"):a.indexOf("painreport")>-1?window.location="jsHandler://killApp":r||t||(window.location="jsHandler://killApp")}else"Android"===o&&e.testNativeAndroidAppUA()?jsHandler.killApp():e.changePage("/home")},e.testNativeAndroidAppUA=function(){return/painreport/.test(navigator.userAgent)},e.getMobileOperatingSystem=function(){var e=navigator.userAgent||navigator.vendor||window.opera;return e.match(/iPad/i)||e.match(/iPhone/i)||e.match(/iPod/i)?"iOS":e.match(/Android/i)?"Android":"unknown"}}])}();